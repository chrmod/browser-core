<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cliqz - Debug Query</title>

    <style type="text/css">
body {
    font-family: 'Open Sans', sans-serif;
}

#query {
    margin:5px;
}

#query_text {
    font-style: italic;
}

#query_nav {
    font-size: 10pt;
    display: inline-block;
}

#query_nav span {
    text-decoration: underline;
}


    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<script type="text/javascript">
    Components.utils.import('chrome://cliqzmodules/content/CliqzUtils.jsm');
    Components.utils.import('chrome://cliqzmodules/content/CliqzQueryDebug.jsm');
    Components.utils.import('chrome://cliqzmodules/content/CliqzClusterHistory.jsm');

    var query_num = 0;

    $(document).ready(function() {
        $("#cluster").on("submit", function(){
            var url_text = $("#urls").val();
            var url_list = url_text.split('\n');
            var urls = []
            for(var i = 0; i < url_list.length; i++) {
                var parts = url_list[i].split("|",2);
                var url = parts[0];
                var title;
                if(parts.length < 2 || !parts[1] || parts[1] == "")
                    title = "TITLE " + i;
                else
                    title = parts[1];
                var url_obj = { 'value': url,
                        'comment': title
                    };
                urls.push(url_obj)
            }
            showresultTable(CliqzClusterHistory.templates[$("#domain").val()].fun(urls));
//            load_rules($("#domain").val(), urls);
            return false;
        });

    });

    function showresultTable(data) {
        $("#resultTable").html("");
        $("#resultTable").append("<tr><th>" + data.summary + "</th></tr>");
        
        $("#resultTable").append("<tr><th>Controls</th></tr>");
        for (var i = 0; i < data.control.length; i++) {
            $("#resultTable").append("<tr>");
            $("#resultTable tr").last().append("<td>" + data.control[i].title + "</td>");
            $("#resultTable tr").last().append("<td>" + data.control[i].url + "</td>");
            $("#resultTable").append("</tr>");
        };    

        for (var i=0; i<data.topics.length; i++) {
            $("#resultTable").append("<tr><th>" + data.topics[i].label + "</th></tr>");
                for (var j=0; j<data.topics[i].urls.length; j++) {
                    $("#resultTable").append("<tr>");
                    $("#resultTable tr").last().append("<td>" + data.topics[i].urls[j].title + "</td>");
                    $("#resultTable tr").last().append("<td>" + data.topics[i].urls[j].href + "</td>");
                    $("#resultTable").append("</tr>");
                }
        }

        $("#resultTable").append("<tr><th>Uncategorized</th></tr>");
        for (var i = 0; i < data.uncategorized.length; i++) {
            $("#resultTable").append("<tr>");
            $("#resultTable tr").last().append("<td>" + data.uncategorized[i].title + "</td>");
            $("#resultTable tr").last().append("<td>" + data.uncategorized[i].url + "</td>");
            $("#resultTable").append("</tr>");
        };    


        $("#resultTable").append("</table>");    
    }

    function load_rules(domainForTemplate, urls) {
        var file = 'chrome://cliqz/content/cluster-' + domainForTemplate + '.json';
        CliqzUtils.httpGet(file,
            function success(req){
                console.log("Clustering based on " + file);
                rules = JSON.parse(req.response);
                showresultTable(categorize_urls(rules, urls));
            },
            function error(){
                console.log("could not load " + file);
            }
        );
    }

    function categorize_urls(rules, fullHistory) {
        var history = fullHistory;
        var cluster = { 
            "summary": CliqzUtils.getLocalizedString(rules.summary).replace('{}', rules.title),
            "url": rules.url,
            "control_set": {},
            "control": [],
            "topics": [],
            "uncategorized": [],
         };
        for(var i = 0; i < rules.length; i++) {
            if(rules[i].type == "control") {
                var control = {
                    "title": rules[i].title,
                    "url": rules[i].url
                };
                cluster.controls.push(control);
            } else if(rules[i].type == "exclude") {
                apply_exclude_rule(rules[i], history);
            } else if(rules[i].type == "topic") {
                apply_topic_rule(rule, history, cluster.topics)
            }
        }

        // Place the remaining uncategorized urls into a separate entry
        for(var i = 0; i < history.length; i++ ) {
            var entry = {
                "title": history[i].comment,
                "url": history[i].value
            }
            cluster.uncategorized.push(entry);
        }
        return cluster;

    }

    function apply_exclude_list(rule, history) {

    }

    function apply_topic_rule(rule, history, topics) {

    }

</script>


</head>
<body>

    <div id="query">
        <p>List of URLs</p>
        <form id="cluster" action="#">
            <input type="text" id="domain" value="amazon.de"><br>
            <textarea id="urls" rows="25" cols="50"></textarea><br>
            <input type="submit">
        </form>
    </div>
    <div id='resultWrapper'>
    <table id="resultTable" border="0" cellspacing="1" cellpadding="4" bordercolor="white"></table>
    </div>
</body>
</html>
